<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/category.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%-include("../partials/admin/header")%>
            <!-- Main Content -->
             <div class="col-md-9 col-lg-10 main-content">
                <div class="row main-header">
                    <div class="col-md-6">
                        <h2>Categories</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end align-items-center">
                            <form class="search-container me-4" id="searchForm" action="/admin/category" method="GET">
    <div style="display:flex; justify-content: space-around;">
        <input 
            type="text" 
            name="search"  
            class="form-control search-input" 
            placeholder="Search" 
            id="searchInput"
            value="<%= search %>"  >
        <button type="submit" class="btn btn-primary ms-2">Search</button>
        <button type="button" class="btn btn-secondary ms-2" id="clearBtn">Clear</button> 
    </div>
</form>
                            
                            <a href="#" class="btn-add" data-bs-toggle="modal"
                      data-bs-target="#addModal">
                                <i class="fas fa-plus me-1"></i> Add Category
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 20%">Category Name</th>
                                    <th style="width: 35%">Description</th>
                                    <th style="width: 15%">Status</th>
                                    <th style="width: 15%">List/Unlist</th>
                                    <th style="width: 15%" class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
    <% for (let i = 0; i < cat.length; i++) { %>
  <tr>
    <td><strong><%= cat[i].name %></strong></td>
    <td><%= cat[i].description %></td>

    <!-- Status badge (gives a class we can target) -->
   <td>
                        <span class="badge <%= cat[i].isListed ? 'bg-success' : 'bg-danger' %>">
                            <%= cat[i].isListed ? 'Listed' : 'Unlisted' %>
                        </span>
                    </td>
                    <td>
                        <button 
                            class="btn btn-sm <%= cat[i].isListed ? 'btn-warning' : 'btn-success' %> toggle-status" 
                            data-category-id="<%= cat[i]._id %>"
                            data-current-status="<%= cat[i].isListed %>">
                            <%= cat[i].isListed ? 'Unlist' : 'List' %>
                        </button>
                    </td>

    <td class="text-end">
      <a href="#" class="btn-edit me-2" data-bs-toggle="modal"
         data-bs-target="#editModal" data-id="<%= cat[i]._id %>" data-name="<%= cat[i].name %>"
         data-description="<%= cat[i].description %>">
        <i class="fas fa-edit"></i> Edit
      </a>
      <button class="btn-delete delete-btn" data-category-id="<%= cat[i]._id %>">
        <i class="fas fa-trash"></i> Delete
      </button>
    </td>
  </tr>
<% } %>

</tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation" class="pt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" 
               href="/admin/category?page=<%= currentPage - 1 %>&search=<%= search %>" 
               aria-label="Previous">
                <span aria-hidden="true">«</span>
            </a>
        </li>
        
        <% for (let i = 1; i <= 1; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a class="page-link" 
                   href="/admin/category?page=<%= i %>&search=<%= search %>">
                   <%= i %>
                </a>
            </li>
        <% } %>
        
        <li class="page-item <%= currentPage === totalPages || totalPages === 0 ? 'disabled' : '' %>">
            <a class="page-link" 
               href="/admin/category?page=<%= currentPage + 1 %>&search=<%= search %>" 
               aria-label="Next">
                <span aria-hidden="true">»</span>
            </a>
        </li>
    </ul>
</nav>
    <!-- Add Category Modal -->
    <div
      class="modal fade"
      id="addModal"
      tabindex="-1"
      aria-labelledby="addModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addModalLabel">Add New Category</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
           <form id="addCategoryForm" action="/admin/add-category" method="POST">

              <div class="mb-3">
                <label for="name" class="form-label">Category Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                />
                <div class="invalid-feedback" id="name-error"></div>
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="description"
                  name="description"
                  rows="3"
                  required
                ></textarea>
                <div class="invalid-feedback" id="description-error"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveCategory">
              Save Category
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Category Modal -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Category</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editCategoryForm">
              <input type="hidden" id="edit-id" name="id" />
              <div class="mb-3">
                <label for="edit-name" class="form-label">Category Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-name"
                  name="name"
                  required
                />
                <div class="invalid-feedback" id="edit-name-error"></div>
              </div>
              <div class="mb-3">
                <label for="edit-description" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="edit-description"
                  name="description"
                  rows="3"
                  required
                ></textarea>
                <div class="invalid-feedback" id="edit-description-error"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="updateCategory">
              Update Category
            </button>
          </div>
        </div>
      </div>
    </div>
   
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Clear search input
        // Clear search input
document.getElementById("clearBtn").addEventListener("click", function () {
    // ഇൻപുട്ട് ബോക്സ് ക്ലിയർ ചെയ്യുന്നു
    document.getElementById("searchInput").value = "";
    
    // '/admin/category' പേജിലേക്ക് റീഡയറക്ട് ചെയ്യുന്നു. (Query-യിൽ search= ഉണ്ടാവില്ല)
    window.location.href = "/admin/category";
});
       
//addmodal
        $("#saveCategory").click(function () {
      $("#addCategoryForm").submit();
        });
      
      //editModal
     $(document).on("click", ".btn-edit", function () {
    const id          = $(this).data("id");
    const name        = $(this).data("name") || "";
    const description = $(this).data("description") || "";

    $("#edit-id").val(id);
    $("#edit-name").val(name);
    $("#edit-description").val(description);

    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
    editModal.show();
});

//put
$("#updateCategory").click(function () {
    const id = $("#edit-id").val();
    const name = $("#edit-name").val();
    const description = $("#edit-description").val();

    $.ajax({
        url: "/admin/edit-category/" + id,
        method: "PUT",
        data: {
            name: name,
            description: description
        },
        success: function (res) {
            Swal.fire({
                icon:"success",
                title:"Category updated successfully"
            })
            .then(() => location.reload());
        },
        error: function (err) {
            Swal.fire({
                icon:"Error",
                title:"Something went wrong"
            })
            
        }
    });
});

//list or unlist
document.querySelectorAll('.toggle-status').forEach(button => {
    button.addEventListener('click', function() {
        const categoryId = this.dataset.categoryId;
        const currentStatus = this.dataset.currentStatus === 'true'; 

        const newStatus = !currentStatus;
      
        Swal.fire({
            title: newStatus ? 'Confirm Listing?' : 'Confirm Unlisting?',
            text: newStatus 
                ? 'Are you sure you want to List this category and make it visible on the website?' 
                : 'Are you sure you want to Unlist this category and hide it from the website?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: newStatus ? '#28a745' : '#dc3545', 
            cancelButtonColor: '#6c757d',
            confirmButtonText: newStatus ? 'Yes, List it!' : 'Yes, Unlist it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/admin/category/${categoryId}/status`, {
                    method: 'PATCH', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ isListed: newStatus }), 
                })
                .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            title: 'Success!',
                            text: newStatus ? 'Category successfully Listed.' : 'Category successfully Unlisted.',
                            icon: 'success',
                            confirmButtonColor: '#007bff'
                        }).then(() => {
                             window.location.reload(); 
                        });
                    } else {
                         Swal.fire({
                            title: 'Error!',
                            text: 'A problem occurred while changing the status. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#007bff'
                        });
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    Swal.fire({
                        title: 'Network Error!',
                        text: 'Could not connect to the server. Check your console for details.',
                        icon: 'error',
                        confirmButtonColor: '#007bff'
                    });
                });
            }
        });
    });
});

//deleted category
document.querySelectorAll('.delete-btn').forEach(button=>{
  button.addEventListener('click',function(){
    const categoryId = this.dataset.categoryId
    swal.fire({
      icon:'warning',
      title:"confirm deletion",
      text:"Are you sure you want to delete this category?",
      showCancelButton: true,
            confirmButtonColor: '#dc3545', 
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Delete it!'
    }).then((result)=>{
      if (result.isConfirmed){
        fetch(`/admin/category/${categoryId}/delete`, {
                    method: 'PATCH', 
                    headers: {
                        'Content-Type': 'application/json',
                    }
                    
                })
                .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Category successfully marked as deleted.',
                            icon: 'success',
                            confirmButtonColor: '#007bff'
                        }).then(() => {
                             window.location.reload();
                        });
                    } else {
                        
                         Swal.fire({
                            title: 'Error!',
                            text: 'Failed to delete the category.',
                            icon: 'error',
                            confirmButtonColor: '#007bff'
                        });
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    Swal.fire({
                        title: 'Network Error!',
                        text: 'Could not connect to the server.',
                        icon: 'error',
                        confirmButtonColor: '#007bff'
                    });
                });
      }
    })
  })
})
  
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>